---
title: "Lab: Creating Good Graphics"
author: "Grey Gergen"
format: html
number-sections: true
number-depth: 2
messages: false
errors: false
warnings: false
editor: 
  markdown: 
    wrap: sentence
---

::: callout
You can see the purpose of this assignment as well as the skills and knowledge you should be using and acquiring, in the [Transparency in Learning and Teaching (TILT)](tilt.qmd) document in this repository.
The TILT document also contains a checklist for self-reflection that will provide some guidance on how the assignment will be graded.
:::

# Graphical Critiques

The following code was [generated by Claude AI vers. Sonnet 4.5](4-types-graphics-claude.md) (with some modifications).

```{r}
#| label: fig-comparing-graphics-figures
#| fig-cap: "Four different representations of COVID vaccination rates."
#| fig-subcap: ["People over 50 make up the majority of vaccinations.", "Vaccination rates increase over the measured 12 weeks.", "Vaccination rates have increased over the 12 week period", "Younger people are less vacinated than older people but all age groups have increased vaccinations over the 12 week period"]
#| fig-alt: ["Pie Chart showing the percentage of vaccinations that each age group made up in proportion to total vaccinations.", "Line graph with a line for each age group. The x axis is each week 1 - 12 and the y axis is the percentage of vaccinations for that age group.", "Stacked area chart whith 4 areas colored in different colors for each age group. The x axis is the weeks plotted 1-12 and the y axis is the cumulative vaccination rate", "Grouped bar chart where age group is separated into 4 different colored bars for the 4 age groups for each point on the x axis. The x axis represents the weeks 1 - 12 and the y axis is the percent vaccination rate for that age group."]
#| layout-ncol: 2
#| code-fold: true


# Load required libraries
suppressPackageStartupMessages({
  library(ggplot2)
  theme_set(theme_bw())
  library(dplyr)
  library(tidyr)
})

# Create sample dataset
set.seed(123)
weeks <- 1:12
age_groups <- c("18-29", "30-49", "50-64", "65+")

# Generate vaccination rate data with realistic patterns
vaccination_data <- data.frame(
  week = rep(weeks, each = 4),
  age_group = rep(age_groups, times = 12),
  vaccination_rate = c(
    # Week-by-week data for each age group
    12, 18, 25, 35,  # Week 1
    15, 22, 30, 41,  # Week 2
    18, 26, 35, 47,  # Week 3
    22, 31, 41, 54,  # Week 4
    26, 36, 47, 60,  # Week 5
    30, 41, 53, 66,  # Week 6
    34, 46, 58, 71,  # Week 7
    38, 50, 63, 75,  # Week 8
    42, 54, 67, 79,  # Week 9
    45, 58, 71, 82,  # Week 10
    48, 61, 74, 85,  # Week 11
    51, 64, 77, 87   # Week 12
  )
)

# Set factor levels for consistent ordering
vaccination_data$age_group <- factor(vaccination_data$age_group, 
                                     levels = c("18-29", "30-49", "50-64", "65+"))

# Define color palette
age_colors <- c("18-29" = "#FF6B6B", 
                "30-49" = "#4ECDC4", 
                "50-64" = "#FFD93D", 
                "65+" = "#95E1D3")

# CHART A: 3D Pie Chart (showing total vaccinations by age group)

# Calculate total vaccinations per age group (sum across weeks)
total_by_age <- vaccination_data %>%
  group_by(age_group) %>%
  summarise(total = sum(vaccination_rate))

# Create pie chart with 3D-like appearance using custom positioning
chart_a <- ggplot(total_by_age, aes(x = "", y = total, fill = age_group)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = age_colors) +
  labs(title = "Chart A: 3D Pie Chart - Total Vaccinations by Age Group",
       subtitle = "(Summed across all 12 weeks)",
       fill = "Age Group") +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    legend.position = "right",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 10)
  ) +
  # Add percentage labels
  geom_text(aes(label = paste0(round(total/sum(total)*100, 1), "%")),
            position = position_stack(vjust = 0.5),
            size = 4, fontface = "bold")

# CHART B: Line Graph - Vaccination Rates Over Time

chart_b <- ggplot(vaccination_data, aes(x = week, y = vaccination_rate, 
                                        color = age_group, group = age_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = age_colors) +
  scale_x_continuous(breaks = 1:12) +
  labs(title = "Chart B: Line Graph - Vaccination Rates Over Time",
       x = "Week",
       y = "Vaccination Rate (%)",
       color = "Age Group")

# CHART C: Stacked Area Chart - Vaccination Rates Over Time

chart_c <- ggplot(vaccination_data, aes(x = week, y = vaccination_rate, 
                                        fill = age_group)) +
  geom_area(alpha = 0.8, position = "stack") +
  scale_fill_manual(values = age_colors) +
  scale_x_continuous(breaks = 1:12) +
  labs(title = "Chart C: Stacked Area Chart - Vaccination Rates Over Time",
       x = "Week",
       y = "Cumulative Vaccination Rate (%)",
       fill = "Age Group")


# CHART D: Grouped Bar Chart - Vaccination Rates by Week and Age Group

chart_d <- ggplot(vaccination_data, aes(x = factor(week), y = vaccination_rate, 
                                        fill = age_group)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.8) +
  scale_fill_manual(values = age_colors) +
  labs(title = "Chart D: Grouped Bar Chart - Vaccination Rates by Week and Age Group",
       x = "Week",
       y = "Vaccination Rate (%)",
       fill = "Age Group")

chart_a
chart_b
chart_c
chart_d
```

1.  Edit the chunk options above to produce helpful and descriptive captions and alt-text for each chart. Every chart you include in a document should be referenced in the text (preferably using a cross-reference) and should have a helpful caption and include at least short alt-text descriptions using the `fig-alt` quarto option.\
    Resources:

-   [Mastering Alt Text for Images and Charts](https://a11ykat.medium.com/see-the-unseen-mastering-alt-text-for-images-and-charts-6d3dbe36553b)
-   [Image Accessibility Generator](https://asuo-ai-labs.streamlit.app/Image_Accessibility) - This is a great tool but I often have to customize the output. I usually use the long text for image descriptions, which is not *best* practice but tends to work better than many of the other options available within the quarto ecosystem.

2.  Using the grammar of graphics, identify the geom, mappings, stat, positions, coordinate systems, and transformations for each graphic. Fill in the table below accordingly, leaving any cells which do not apply to the chart blank. If a mapping is a function of a statistic, fill in the statistic function from ggplot2 and indicate the mapping using the appropriate [`after_stat` variable](https://ggplot2.tidyverse.org/reference/aes_eval.html.).

| Chart | Geom | X mapping | Y mapping | Color mapping | Fill mapping | Stat | Position | Coord System | Transform |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| A | Bar | Null | total vaccination | age group | percentage of vaccination | identity | Null | Polar | Null |
| B | Line, Point | week | vaccination rate | age group | Null | Null | Null | Cartesian | Null |
| C | Area | week | vaccination rate | Null | age group | Null | stack | Cartesian | Null |
| D | Bar | week | vaccination rat | Null | age group | identity | dodge | Cartesian | Null |

: Grammar of graphics mappings for the four charts

3.  Examine each chart and determine whether it effectively communicates changes in vaccine rates over time across different age groups.
    If the chart is inappropriate for that comparison, explain why; if it is appropriate but not optimal, explain what you would change.

    A.  This does not represent change over time since it is a a representation of how each age group makes up the total vaccination rate.

    B.  Yes, this graph shows changes in vaccine rates over time across different age groups.

    C.  While this graph does show changes in vaccine rates over time across different age groups, it does not do a good job of it.
        Using a stacked area chart makes the actual percentages of vaccination rates difficult to read.
        If you want to use an area chart I would graph only one age group at a time and facet the four graphs together.

    D.  Yes, this graph shows changes in vaccine rates over time across different age groups.

4.  Examine each chart and critique the use of Gestalt principles of grouping.
    What principles apply?
    Are they used effectively?

    A.  The pie chart uses closure effectively and there is good continuation.

    B.  The line graph uses similarity effectively where the points and lines are the same size and length.

    C.  The area chart uses closure but it doesn't necessarily convey the message of the data effectively.

    D.  The bar graph uses proximity effectively to show age group each week effectively.

5.  Consider the "messages" you might want viewers to take away from this data and the visuals you generate.

    a.  Brainstorm 2-3 reasonable messages

    > Vaccinations are increasing over time.
    > Older people are more vaccinated than younger people.

    b.  What do you think the most important message is from this data set?

    > Older people are more vaccinated than younger people.

    c.  Which comparisons do you want to make easier for participants to perform?

    > Total vaccination rate, vaccination rate per age, vaccination rate over time.

    d.  What obstacles do you expect to encounter designing a chart to facilitate these comparisons?

    > Conveying the message in a clear way that is not too cluttered visually.

6.  Considering your answers to the questions above, create your own version of the chart that minimizes cognitive load and maximizes interpretability.
    Explain the changes that you made and why they improve the chart compared to the ones generated by Claude.

```{r}
vaccination_data_total <- vaccination_data %>%
    group_by(week) %>%
    mutate(vaccination_rate = mean(vaccination_rate)) %>%
    mutate(age_group = "All Ages Avg") %>%
    distinct()

vaccination_data <- rbind(vaccination_data, vaccination_data_total)

age_colors <- c("18-29" = "gray", 
                "30-49" = "orange", 
                "50-64" = "blue", 
                "65+" = "black",
                "All Ages Avg" = "red")

chart_e <- ggplot(vaccination_data, aes(x = week, y = vaccination_rate, 
                                        color = age_group, group = age_group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = age_colors) +
  scale_x_continuous(breaks = 1:12) +
  labs(title = "Chart B: Line Graph - Vaccination Rates Over Time",
       x = "Week",
       y = "Vaccination Rate (%)",
       color = "Age Group")

chart_e
```

# Choose Your Own Adventure

Claude used fake data, but we have access to the [real deal](https://data.cdc.gov/Vaccinations/Weekly-Cumulative-Estimated-Number-of-COVID-19-Vac/ewpg-rz7g/about_data), and I've downloaded a [csv](Weekly_Cumulative_Estimated_Number_of_COVID-19_Vaccinations_Administered_in_Pharmacies_and_Physician_Medical_Offices,_Adults_18_years_and_older,_by_Season_and_Age_Group,_United_States_20251021.csv) to simplify the process.

Of course, the CDC only tracks number of vaccines, not the overall vaccination rate.

1.  Augment this data with census estimates of the population size for each age group.
    In either case, you may need to do a bit of inference/subtraction to get the counts for the age brackets used by the CDC.
    Provide reproducible code that generates a population table for 2023 and 2024 with the appropriate counts for each age bracket provided by the CDC.

    Options:

    -   Use the Census QuickFacts page https://www.census.gov/quickfacts/
    -   Use the [nc-est2024-agesex.xlsx](nc-est2024-agesex.xlsx) population by age and sex file I downloaded from the [US Census](https://www.census.gov/data/tables/time-series/demo/popest/2020s-national-detail.html).
    
```{r}
ages <- readxl::read_xlsx("nc-est2024-agesex.xlsx")

vaccs <- read.csv("Weekly_Cumulative_Estimated_20251021.csv")
```
```{r}
ages1 <- ages %>%
    select(1, 14, 17) %>%
    drop_na()

colnames(ages1) <- c("Age", "2023", "2024")

ages1 <- ages1 %>%
  mutate(Age = case_when(
    Age == ".Under 5 years" ~ "0-4",
    Age == ".5 to 9 years" ~ "5-9",
    Age == ".10 to 14 years" ~ "10-14",
    Age == ".15 to 19 years" ~ "15-19",
    Age == ".20 to 24 years" ~ "20-24",
    Age == ".25 to 29 years" ~ "25-29",
    Age == ".30 to 34 years" ~ "30-34",
    Age == ".35 to 39 years" ~ "35-39",
    Age == ".40 to 44 years" ~ "40-44",
    Age == ".45 to 49 years" ~ "45-49",
    Age == ".50 to 54 years" ~ "50-54",
    Age == ".55 to 59 years" ~ "55-59",
    Age == ".60 to 64 years" ~ "60-64",
    Age == ".65 to 69 years" ~ "65-69",
    Age == ".70 to 74 years" ~ "70-74",
    Age == ".75 to 79 years" ~ "75-79",
    Age == ".80 to 84 years" ~ "80-84",
    Age == ".85 years and over" ~ "85+",
    Age == ".18 years and over" ~ "18+",
    Age == ".18 to 24 years" ~ "18-24",
    Age == ".25 to 44 years" ~ "25-44",
    Age == ".45 to 64 years" ~ "45-64",
    Age == ".65 years and over" ~ "65+",
    TRUE ~ Age))

ages2 <- ages1 %>%
    mutate(
    `2023` = as.numeric(`2023`),
    `2024` = as.numeric(`2024`),
    AgeGroup = case_when(
    Age %in% c("18-24", "25-29", "30-34", "35-39", "40-44", "45-49") ~ "18-49",
    Age %in% c("50-54", "55-59", "60-64") ~ "50-64",
    Age %in% c("65-69", "70-74", "75-79", "80-84", "85+") ~ "65+",
    TRUE ~ NA_character_)) %>%
  filter(!is.na(AgeGroup)) %>%
  group_by(AgeGroup) %>%
  summarise(
    `2023` = sum(`2023`, na.rm = TRUE),
    `2024` = sum(`2024`, na.rm = TRUE))

vaccs <- vaccs %>%
    filter(Age_Group == "18-49" | Age_Group == "50-64" | Age_Group == "65+") %>%
    filter(MMWR_Year == "2,024" | MMWR_Year == "2,023") %>%
    select(MMWR_Week, MMWR_Year, Doses, Cumulative_Doses, Age_Group) %>%
    mutate(
    MMWR_Year = as.numeric(gsub(",", "", MMWR_Year)),
    Cumulative_Doses = as.numeric(gsub(",", "", Cumulative_Doses))) %>%
    mutate(Week_Year = paste0(MMWR_Year, "-", MMWR_Week))

vacc_rate <- vaccs %>%
  left_join(ages2, by = c("Age_Group" = "AgeGroup")) %>%
  mutate(
    Cumulative_Doses = as.numeric(Cumulative_Doses),
    `2023` = as.numeric(`2023`),
    `2024` = as.numeric(`2024`),
    Population = ifelse(MMWR_Year == 2023, `2023`, `2024`),
    Vaccination_Rate = (Cumulative_Doses / Population) * 100
  ) %>%
  select(MMWR_Week, MMWR_Year, Age_Group, Week_Year, 
         Cumulative_Doses, Population, Vaccination_Rate) %>%
  mutate(Vaccination_Rate = round(Vaccination_Rate, 2))
```

2.  Use the real data to generate the plot you created in 6.
    How does the real data change the appearance/message of the plot?
    Does anything get easier or more difficult?
    
```{r}
vaccination_data_total <- vacc_rate %>%
  group_by(MMWR_Week, MMWR_Year) %>%
  summarise(Vaccination_Rate = mean(Vaccination_Rate, na.rm = TRUE)) %>%
  mutate(Age_Group = "All Ages Avg")

vaccination_data_combined <- vacc_rate %>%
  select(MMWR_Week, MMWR_Year, Week_Year, Age_Group, Vaccination_Rate) %>%
  bind_rows(vaccination_data_total)

age_colors <- c("18-49" = "gray", 
                "50-64" = "orange", 
                "65+" = "blue",
                "All Ages Avg" = "red")

chart_e <- ggplot(vaccination_data_combined, 
                  aes(x = Week_Year, y = Vaccination_Rate, 
                      color = Age_Group, group = Age_Group)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = age_colors) +
  labs(title = "Vaccination Rates Over Time",
       x = "Week-Year",
       y = "Vaccination Rate (%)",
       color = "Age Group") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

chart_e
```

3.  What annotations would you want to add to your chart?
    You may be able to find relevant information about e.g. approval dates of vaccines at [immunize.org's Vaccine Timeline](https://www.immunize.org/vaccines/vaccine-timeline/).
    Add at least one annotation to your chart, but balance utility with clutter.
    
    IT seems that rates are reset each year.

4.  How would you modify this chart if your goal was to compare vaccination rates for each age group in 2023 and 2024?
    Explain your answer, highlighting how your modifications would reduce the cognitive load of making the comparison of interest.
    
    Do each point by month instead of week. This would reduce the amount of clutter but still show the trend.

5.  How would you use your statistical training to test and visually highlight any statistically significant differences?
    Explain.
    You do not have to actually implement any statistical testing to answer this question.
    
    Test if there is a significant difference in vaccination rates between ages.
